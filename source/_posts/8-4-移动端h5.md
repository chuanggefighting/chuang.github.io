---
title: 移动端 H5 开发
tags:
  - App
categories: 移动端
top: false
keywords:
  - app
date: 2019-06-28 22:28:50
description: App、微信公众号、移动端支付
---

# 一、Hybrid App
> 混合开发解决方案：1、JSBridge，2、hybrid 框架 (ReactNative、Weex、Flutter)。

## JSBridge
> 由于 H5 页面是内嵌到原生应用的 WebView 组件 (手机浏览器内核)，JS 没有修改系统配置、读写文件等权限，`JSBridge (WebView JavaScript Bridge)` 则是用于构建 JS、Native 之间消息通信的双向通道，提供了调用对方功能的方法。

  ```js
  // ==== jsBridge.js：封装了 js 调用 Native 的方法 =======
  // app 加载完毕后修改 loadstatus
  window.HQAppGetH5Header = function (n) { 
    window.jsBridge.status.loadstatus = true
  }
  // 呼叫身份证扫描
  window.idCardScan = function (options) {
    clearTimer()
    const idcard = function () {
      return new Promise((resolve, reject) => {
        window.jsBridge.status.idCard.status = false
        window.jsBridge.status.idCard.value = ''
        options = options ? JSON.stringify(options) : undefined
        window.HQAppJSInterface.requestScanCertificateCard(options)
        window.__tid = window.setInterval(success => {
          if (window.jsBridge.status.idCard.status) {
            clearTimer()
            resolve(SetCustomerRules(window.jsBridge.status.idCard.value))
            window.jsBridge.status.idCard.status = false
            window.jsBridge.status.idCard.value = ''
          } else {
            // reject('fail')
          }
        }, 30)
      })
    }
    return window.checkload().then(function (data) {
      return idcard()
    })
  }
  // 导入银行卡
  window.getBank = function () {
    clearTimer()
    const bank = function () {
      return new Promise((resolve, reject) => {
        window.jsBridge.status.bank.status = false
        window.jsBridge.status.bank.value = ''
        window.HQAppJSInterface.requestScanBankCard()
        window.__tid = window.setInterval(success => {
          // alert('job=' + window.jsBridge.status.bank.status)
          if (window.jsBridge.status.bank.status) {
            clearTimer()
            // alert('job start=' + window.jsBridge.status.bank.status)
            resolve(window.jsBridge.status.bank.value)
            window.jsBridge.status.bank.status = false
            window.jsBridge.status.bank.value = ''
          } else {
            // reject('fail')
          }
        }, 30)
      })
    }
    return window.checkload().then(function (data) {
      return bank()
    })
  }
  // 呼叫app 照相机
  let timeid
  window.callCamera = function (n) {
    clearTimer()
    let camera = function () {
      return new Promise((resolve, reject) => {
        window.jsBridge.status.index += 1
        window.jsBridge.status['camera' + window.jsBridge.status.index] = {
          status: false,
          value: ''
        }
        window.jsBridge.status.camera.status = false
        window.jsBridge.status.camera.value = ''
        window.HQAppJSInterface.takeUserImage()

        window.__tid = window.setInterval(success => {
          if (window.jsBridge.status.camera.status) {
            clearTimer()
            resolve(window.jsBridge.status.camera.value, n)
            window.jsBridge.status.camera.status = false
            window.jsBridge.status.camera.value = ''
          } else {
            // reject('fail')
          }
        }, 30)
      })
    }
    return window.checkload().then(function (data) {
      return camera()
    })
  }
  // 呼叫app 照相机-裁剪
  window.tailorCamera = function (n, bool, width, height) {
    clearTimer()
    let camera = function () {
      return new Promise((resolve, reject) => {
        window.jsBridge.status.index += 1
        window.jsBridge.status['camera' + window.jsBridge.status.index] = {
          status: false,
          value: ''
        }
        window.jsBridge.status.camera.status = false
        window.jsBridge.status.camera.value = ''
        window.HQAppJSInterface.takeUserImage(bool, width, height)

        window.__tid = window.setInterval(success => {
          if (window.jsBridge.status.camera.status) {
            clearTimer()
            resolve(window.jsBridge.status.camera.value, n)
            window.jsBridge.status.camera.status = false
            window.jsBridge.status.camera.value = ''
          } else {
            // reject('fail')
          }
        }, 30)
      })
    }
    return window.checkload().then(function (data) {
      return camera()
    })
  }


  // ============ 组件调用 ============
  window.idCardScan().then(response => {
    this.$emit('scan', JSON.parse(response))
  })
  window.getBank().then(JSON.parse).then(this.onScan).catch(toast)
  ```



# 二、微信公众号

## 基础介绍

### 公众号类型
> 订阅号存放在一个文件夹中且需要点开查看关注，服务号直接显示在聊天列表。个人只能申请订阅号，几乎没有可用的接口。

  * __订阅号__：主要用于推送资讯而让用户阅读，每天只能群发一条消息。
  * __服务号__：主要用于为企业、政府等提供对用户的服务，比如银行的服务号可以让用户查询账单等，每个月只可群发四条消息。
  * __企业号__：主要用于公司内部通讯使用，旨在为用户提供移动办公，需要先有成员的通讯信息验证才可以关注成功企业微信。
  * __测试号__：用于开发测试及功能体验，是专门为开发人员准备的一种仅用于测试的公众号，但不可使用微信支付等高级功能。


### 微信公众平台
  <div style="text-indent: 2em">用于管理注册过的公众号，比如自定义菜单、自动回复、推送文章等，主要有两种管理模式：__编辑模式__就是为所有人提供的，如果你的需求仅仅只是最常见的菜单、自动回复等，使用编辑模式已经满足。但是如果你需求的功能比较复杂，就需要使用到__开发模式__。</div>

  * __编辑模式__：主要针对非编程人员及信息发布类公众帐号使用，开启后可以直接通过界面配置自定义菜单、自动回复的消息。优点是可视化界面配置、操作简单快捷，但功能有限。
  * __开发模式__：主要针对开发人员使用，开启后可以使用微信公众平台的开放接口，但编辑模式的自定义菜单等功能会失效。优点是可以实现更多的复杂功能，提供个性化服务。


### 开发工具

  * __技术文档__：[微信公众平台开发文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432/)、[接口在线调试网址](http://mp.weixin.qq.com/debug/)。
  * __测试账号__：拥有几乎所有的公众号接口但不支持微信支付，主要用于手机端开发测试。
  * __微信 API 在线调试__：后端代码与微信服务器交互实现创建自定义菜单等功能，手机端可通过扫描测试号二维码查看最新效果。
  * __微信开发者工具__：自带审查元素功能的微信浏览器，用于调试微信端页面。使用前需要绑定开发者微信号 (公众平台首页、开发者工具)。
  * __JS-SDK 工具包__：基于微信内的网页开发工具包。开发者可用来借助微信高效地使用拍照、选图、语音、位置等手机系统的能力，而且可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验。


## 开发准备

### 公众号配置
> 手机端调试：扫码关注测试二维码。公众号域名可以是 http/https，小程序必须是 https。

  1. 注册一个服务号并认证通过：只有服务号可以开通微信支付。
  2. 管理员为开发者添加服务号和商户平台的用户管理权限：微信公众平台的权限为运营者微信号、微信商户平台的权限为员工账号。
  3. __开通微信支付功能__
    * 公众号：拥有通过微信认证的公众帐号且为服务号、服务号和商户平台必须是一个账户主体(认证的公司一致)。
    * 商户平台：产品中心处开通公众号支付、扫码支付等所需要的支付方式，然后配置支付授权目录。注意小程序也属于公众号支付，不需要单独开通。
  4. __配置公众号__
    * 测试账号：JS 接口安全域名 (用于实现微信分享等功能，不需要加 http/https)、授权回调页面域名 (用于用户登录和基本信息获取，只支持 80 端口，务必使服务器监听 80 端口)、接口配置信息 (URL、Token 由后端提供)。
    * IP 白名单：在公众号后台设置服务器 IP 为白名单，否则无法获取 access_token。
    * 自定义菜单：上线时配置 公众号网址 + 各个菜单对应的前端路由，比如公司简介 `https://wx.shanghailife.com.cn/aboutus`。


### 搭建内网穿透环境
> 本地测试需要通过内网穿透环境或代理。

  <div style="text-indent: 2em">公众号开发涉及到微信的回调，所以本地调试的服务器需要外网能够访问。运行在本地的内网服务器和外网服务器实现连接通信的解决方案有两种：一是__购买域名、云服务器并配置代理__，将本地服务器网址映射到外网。二是使用__内网穿透技术__，让本地服务器直接穿透到外网。我们一般通过拥有免费通道的 natapp 实现内网穿透，但缺点是外网访问本地项目的地址经常会变化而不太稳定，具体的配置步骤如下：</div>


  1. 登录并购买免费隧道：首次需要[注册](https://natapp.cn/register)、点击购买并配置地址 `http://127.0.0.1:80`。
  2. 本机运行 web 服务：配置地址 `http://127.0.0.1:80`。
  3. 本机运行 natapp 服务：下载 [natapp.exe](https://natapp.cn/#download)、获取 authtoken (我的隧道处)。
    * 直接启动：__natapp -authtoken=9ab6b9040a624f40__
    * 通过 config.ini：[下载 config.ini](https://natapp.cn/article/config_ini) 并填入 authtoken 后双击启动。
  4. 测试 natapp 分配的网址：拔掉电脑网线后在浏览器地址栏打开即可。


### 微信接口参数
  
  * __appid__：公众号唯一标识。
  * __secret__：公众号开发密钥。
  * __openid__：用户单平台的唯一标识，每个微信用户关注后都会生成唯一的 openid。
  * __code__：用户授权时用于获取 access_token，只能使用一次且 5分钟未被使用则自动过期。
  * __unionid__：用户跨微信平台的唯一标识，同一个用户在公众号和小程序拥有相同的 unionid 和不同的 openid。
  * __redirect_uri__：完成授权后重定向的回调链接（其实是用户要访问的页面，注意转义）。
  * __response_type__ ：返回类型，固定为 code。
  * __state__：重定向后被微信原样返回，可用于前后对比来防止别人的攻击。
  * __scope__：授权方式。snsapi_base (不弹出授权页面而直接跳转，只能获取用户 openid)、snsapi_userinfo (弹出授权页面，可通过 openid 获取昵称、性别、所在地等信息)。
  * __#wechat_redirect__：直接在微信打开链接的可选参数。实现页面 302 重定向时必须携带。
  

## 常用功能

### 获取用户信息
> 用户通过扫码、点击按钮等方式进入公众号页面，没有用户信息时跳转到微信授权页面，用户同意授权后则自动跳转到携带参数 code、state 的回调页面，然后才能发送请求获取用户信息。

  <div align="center"> 
    ![授权流程](/images/webchat/auth.png)
  </div>

  ```js
  // router.js
  import axios from 'axios'
  import store from './store'
  import {getQuery, goToWechatAuth} from 'assets/js/utils'
  router.beforeEach((to, from, next) => {
    let userInfo = store.state.userInfo
    if (userInfo) {
      next()
    } else {
      // 路由没有 code、请求用户信息失败跳转到授权页面
      const code = getQuery("code")
      if(!code) {
        goToWechatAuth()
      }
      // 获取用户信息
      let res = await axios.get(requestLink('/WeChat?code=' + code))
      if (res.success) {
        store.dispatch('setUserInfo', res.data.data)
        next()
      } else {
        goToWechatAuth()
      }
    }
  })

  // utils.js
  export default {
    isWechat: navigator.userAgent.toLowerCase().indexOf("micromessenger") > -1,
    isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
    getQuery(key){
      var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
      let r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]);
      return null;
    },
    removeQuery(param){
        let _search = window.location.search
        if(_search.length === 0){
            return window.location.href
        }

        let params = _search.split('?')[1].split('#')[0].split('&'),
            pathname = window.location.pathname

        for(let i in params){
            let temp = params[i].split('=')
            if(temp[0] == param){
                params.splice(i, 1)
                break
            }
        }

        return window.location.protocol + "//" + window.location.host + pathname + '?' + params.join('&')
    },
    // 进入授权页面
    goToWechatAuth(){
      let appid = window.appid,
          URI = encodeURIComponent(this.removeQuery('code')),
          SCOPE = 'snsapi_userinfo';

      window.location.replace(`https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${URI}&response_type=code&scope=${SCOPE}&state=STATE#wechat_redirect`)
    }
  }

  // main.js
  let appid = {
        test: 'wx0431d286df253cea',
        uat: 'wx58656f9344fbc048',
        prd: 'wx7899e3317bf82ab8'
  };
  let domain = '';

  switch(process.env.NODE_ENV){  // 环境配置
    case "development":
      window.appid = appid.test
      domain = "10.52.200.2:9011"
      break
    case "production":
      if(location.href.indexOf('test') > -1){  // test 环境
        window.appid = appid.test
        domain = "shlife-test.zhongan.io"
      }else if(location.href.indexOf('wxdat') > -1){
        window.appid = appid.test
        domain = "wxdat.shanghailife.com.cn"
      }else if(location.href.indexOf('wxpre') > -1){  // uat 环境
        window.appid = appid.uat
        domain = "wxpre.shanghailife.com.cn"
      }else{      // 生产或其它环境
        window.appid = appid.prd
        domain = "wx.shanghailife.com.cn"
      }
      break
  }
  axios.defaults.baseURL = location.protocol + "//" + domain
  ```


### 微信功能
> 公众号的内嵌 H5 页面中实现微信分享、支付等功能需要引入 __JS-SDK__，而且必须先注入配置信息让微信验证是否支持。vue 开发项目需注意：1、路由必须使用 history 模式，因为各个页面需要不同的签名信息，而且安卓设备的微信会自动截取 # 后面的内容而导致无法分享，2、iOS 需要使用第一次进入页面的 URL 获取签名，安卓每次路由切换都重新配置签名，具体如下：

  <div align="center"> 
    ![页面跳转](/images/webchat/mode-skip.png)
  </div>


  ```js
  // 安装
  npm install axios weixin-js-sdk -S

  // wxSetting.js
  import axios from 'axios'
  import wx from 'weixin-js-sdk'
  export default {
    // 初始化
    wxConfig(callback){
      // 微信签名等配置数据需要从服务器获取 (url 参数需要编码)
      let url = encodeURIComponent(location.href.split("#/")[0]);
      axios.get(`/api/getShareSign?url=${url}`).then(res => {
        // 微信验证
        const {appId, timestamp, nonceStr, signature} = res.data
        wx.config({
          debug: true,  // 开启调试模式
          appId,        // 必填，公众号的唯一标识
          timestamp,    // 必填，生成签名的时间戳
          nonceStr,     // 必填，生成签名的随机串
          signature,    // 必填，签名 
          jsApiList: [  // 必填，需要使用的 JS 接口列表
            'updateAppMessageShareData', 
            'updateTimelineShareData',
            'scanQRCode',
            'chooseImage',
            'uploadImage'
          ]
        })
        // 验证成功
        wx.ready(res => {
          // 微信功能函数：share、scan
          callback && callback()
        })
        // 验证失败
        wx.error((err) => {
          console.error(err.errMsg)
        })
      })
    },
    /**
    * 自定义分享
    * @param {Object} data 分享内容
    * @param {String} fullPath 分享路径，传入 this.$route.fullPath
    */
    share(data, fullPath) {
        const {title, imgUrl, desc} = data
        let link = location.protocol + '//' + location.host + fullPath
        // 分享到朋友圈：link 不需要编码但必须加 http://
        wx.updateTimelineShareData({
            title,   // 分享标题
            imgUrl,  // 分享图标
            link,    // 分享链接，该链接域名必须与当前页面对应的公众号 JS 安全域名一致
            success: function () {
              Toast('分享成功');
            }
        });
        // 分享给朋友
        wx.updateAppMessageShareData({
            title,
            desc,
            link,
            imgUrl,
            success: function () {
              Toast('分享成功');
            }
        });
    },
    /**
    * 禁止微信分享
    * @desption share({ hideMenuItems: true }, $route.fullPath)、hideOptionMenu()
    */
    hideOptionMenu() {
      function onBridgeReady() {
        window.WeixinJSBridge.call("hideOptionMenu");
      }
      if (typeof WeixinJSBridge === "undefined") {
        if (document.addEventListener) {
          document.addEventListener("WeixinJSBridgeReady", onBridgeReady, false);
        } else if (document.attachEvent) {
          document.attachEvent("WeixinJSBridgeReady", onBridgeReady);
          document.attachEvent("onWeixinJSBridgeReady", onBridgeReady);
        }
      } else {
        onBridgeReady();
      }
    },
    // 调用微信扫一扫接口
    scan(){
      wx.scanQRCode({
        needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
        scanType: ["qrCode","barCode"], // 指定扫二维码还是一维码，默认二者都有
        success: function (res) {
          var result = res.resultStr; // needResult 为 1 时，扫码返回的结果
        }
      })
    },
    // 图片上传
    openCamera(){
      wx.chooseImage({
        count: 1, // 默认9
        sizeType: ['original', 'compressed'], // 指定是原图还是压缩图，默认都有
        sourceType: ['album', 'camera'],      // 指定来源是相册还是相机，默认都有
        success: function (res) {
          var localIds = res.localIds;
          wx.uploadImage({
            localId: localIds.toString(),  // 图片 ID
            isShowProgressTips: 1,         // 进度提示
            success: function (res) {
              // 图片上传成功
            },
            fail: function (res) {
              // 图片上传失败
            }
          })
        }
      })
    },
    // 微信支付：本质是对微信浏览器内置方法 weixinjsbridge.invoke() 的再次封装
    wxPay(options){
      const {appId, timeStamp, nonceStr, package, signType, paySign} = options
      wx.chooseWXPay({
        appId,
        timestamp: timeStamp,  // 支付签名时间戳，但新版支付后台返回 timeStamp
        nonceStr,   // 支付签名随机串
        package,    // 统一支付接口返回的参数值，提交格式如：prepay_id=\*\*\*
        signType,   // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
        paySign,    // 支付签名
        success: function(res) {
          // 支付成功后的回调函数l
          success && success()
        },
        cancel: function(res) {
          cancel && cancel(res)
        },  
        fail: function(res) {
          // 支付失败回调函数
          error && error(res)
        }
      })
    }
  }
  ```

# 三、移动端支付

## 微信支付
> [微信支付平台开发文档](https://pay.weixin.qq.com/wiki/doc/api/index.html)：`H5 支付、JSAPI 支付、付款码支付、Native 支付、APP 支付、人脸支付、小程序支付`。H5 页面常用的支付方案有两种：微信外的 H5 支付、微信内的公众号支付。

  ```js
  import axios from 'axios'
  import wx from 'weixin-js-sdk'

  // 1、H5 支付：直接跳转到后台返回的支付网址即可，注意需要配置授权目录。
  goWechatPayH5() {
    let _this = this;
    let cur_url = encodeURI(window.location.href + '?openLayer=1')
    axios({ 
      url: '',
      method: 'post',
      data: JSON.stringify(prames)
    }).then((res)=>{
        if (res.code == 200) {
            window.location.href = res.data.mweb_url + '&redirect_url=' + cur_url;
        } else if (res.code === 400) {
            _this.$toast(res.error)
        }
    })
  },
  // 2、JSAPI/公众号 支付：配置数据通过请求后台获取。
  function wxpay(params,callback){
    if (typeof WeixinJSBridge == "undefined"){
      if( document.addEventListener ){
          document.addEventListener('WeixinJSBridgeReady', onBridgeReady(params,callback), false);
      }else if (document.attachEvent){
          document.attachEvent('WeixinJSBridgeReady', onBridgeReady(params,callback)); 
          document.attachEvent('onWeixinJSBridgeReady', onBridgeReady(params,callback));
      }
    }else{
      onBridgeReady(params,callback);
    } 
  }

  function onBridgeReady(params,callback){
    const { appId, timeStamp, nonceStr, package, signType, paySign } = params
    var that = this
    WeixinJSBridge.invoke(
      'getBrandWCPayRequest', {
          appId: "wx2421b1c4370ec43b",      // 公众号 id，由商户传入 
          timeStamp: "1395712654",          // 时间戳，自1970年以来的秒数   
          nonceStr: "e61463f8efa94090",     // 随机字符串  
          package: "prepay_id=u802345jgf",  // 订单详情扩展字符串
          signType: "MD5",                  // 微信签名方式
          paySign: "70EA570631E4BB79"       // 微信签名
      },
      function(res){  
        callback(res)
        switch (res.err_msg) {
          case "get_brand_wcpay_request:ok":
            // 支付成功
            break;
          case "get_brand_wcpay_request:fail":
            // 支付失败
            break;
          case "get_brand_wcpay_request:cancel":
            // 取消支付
            break;
        }
      }
    )
  }
  ```





















