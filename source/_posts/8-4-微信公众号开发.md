---
title: 微信公众号
tags:
  - 移动端
categories: 移动端
top: false
keywords:
  - 移动端项目
date: 2019-07-04 23:10:50
description: 微信公众号的基础介绍和开发流程、移动端支付
---

# 一、微信公众号
> 订阅号存放在一个文件夹中而需要点开查看关注的订阅号，但服务号直接显示在聊天列表

  * __订阅号__：主要用于推送资讯而让用户阅读，每天只能群发一条消息
  * __服务号__：主要用于为企业、政府等提供对用户的服务，比如银行的服务号可以让用户查询账单等，每个月只可群发四条消息
  * __企业号__：主要用于公司内部通讯使用，旨在为用户提供移动办公，需要先有成员的通讯信息验证才可以关注成功企业微信
  * __测试号__：用于开发测试及功能体验，是专门为开发人员准备的一种仅用于测试的公众号，但不可使用微信支付等高级功能


## 微信公众平台
  <div style="text-indent: 2em">用于管理注册过的公众号，比如自定义菜单、自动回复、推送文章等，主要有两种管理模式：__编辑模式__就是为所有人提供的，如果你的需求仅仅只是最常见的菜单、自动回复等，使用编辑模式已经满足。但是如果你需求的功能比较复杂，就需要使用到__开发模式__。</div>

  * __编辑模式__
    * 主要针对非编程人员及信息发布类公众帐号使用
    * 优点是可视化界面配置，操作简单，快捷，但是功能有限
    * 开启后可以方便地通过界面配置 自定义菜单、自动回复的消息
   
  * __开发模式__
    * 主要针对具备开发能力的人使用
    * 通过编程可以实现更多复杂的功能，提供个性化服务
    * 开启后能够使用微信公众平台开放的接口，但是编辑模式的自定义菜单等功能会失效


## 开发工具

  * __技术文档__：[微信公众平台](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432/)
  * __接口调试工具__：http://mp.weixin.qq.com/debug/
  * __接口测试账号__：微信公众平台、开发模式、测试账号
  * __微信web开发者工具__
    * 功能：自带"审查元素"功能的微信浏览器，用于调试微信端页面
    * 准备：公众平台首页、左侧开发者工具、web开发者工具、绑定开发者微信号


## 接口参数
  * __appid__：公众号唯一标识id
  * __secret__：公众号开发密钥
  * __openid__：用户单平台的唯一标识，每个微信用户关注此公众号后都会生成唯一的 openid
  * __unionid__：微信跨平台时保证用户唯一标识，同一个用户在服务号和小程序中的 unionid 相同，openid 则不同
  * __code__：作为换取 access_token 的票据，每次用户授权携带的 code 都不一样，code只能使用一次，5分钟未被使用自动过期
  * __redirect_uri__：回调链接，完成用户授权后微信服务器自动回调的 uri，一般为业务首页链接（注意请转义）
  * __response_type__ ： 固定为 code
  * __scope__： 授权方式 可选静默（snsapi_base） 或者非静默（snsapi_userinfo）
  * __state__： 此参数可为业务需求使用，根据业务需要传入。


# 二、开发准备

## 公众号配置
> 连通小程序和公众号：公众平台首页、基本配置、绑定同一个微信开放平台帐号

  1. __注册一个服务号并认证通过__
    * 个人的订阅号不能开通微信支付，只有服务号可以
    * 服务号和商户平台必须是一个账户主体，即认证的公司需要一致
  2. __开通微信支付功能__
    * 条件：拥有公众帐号且为服务号、公众帐号须通过微信认证
    * 路径：平台首页、点击左侧微信支付、点击支付申请 
  3. __如果不是管理员，则需要添加服务号和商户平台的用户管理权限__
    * 微信公众平台的权限叫做 运营者微信号，在公众平台的左侧、人员设置中添加，需要管理员为我们绑定一个长期的运营者账号
    * 微信商户平台的权限叫做 员工账号，在商户平台、账户中心、左侧员工账号管理、选择某个角色（通常是管理员）、新增账号、按要求填写之后即可
  4. __配置公众号：JS接口安全域名、网页授权域名__
    * 公众号支付的域名可以是 http/https，而小程序则必须是 https
    * 配置路径：公众平台、左侧公众号设置、功能设置、JS接口安全域名/网页授权域名
    * 设置 IP 白名单：公众平台首页、基本配置，获取 access_token 接口才可以调用成功
    * 下载微信的安全配置文件放到服务器，根据 授权的域名+认证文件 可以访问后即可配置完成
    * 需要注意的是，每次修改认证域名都会再次重新认证域名，所以认证以后文件请不要轻易删除。
  5. __在商户平台开通相应的支付产品功能__
    * 登陆微信商户平台、产品中心、开通需要的支付产品，如公众号支付、扫码支付、刷卡支付、H5支付
    * 在商户平台上小程序也属于公众号支付，不需要单独开通
  6. __在商户平台设置支付的相关 ip 授权__：以公众号支付为例，开通公众号支付后，这是还不能进行开发，我们需要拿到商户的几个重要信息（括号内为获取来源）
    * `APP_ID` (公众平台)：公众号、小程序开发者ID (AppID)、公众平台首页、基本配置
    * `APP_SECRET` (公众平台)：开发者密码 (AppSecret)、公众平台首页、基本配置
    * `MCH_ID` (商户平台)：商户号、商户平台首页、账户中心、账户信息
    * `API_KEY` (商户平台)：API 密钥、商户平台首页、账户中心、API 安全
    * `APICLIENT_CERT` (商户平台)：安全证书路径、商户平台首页、账户中心、API 安全



## 搭建内网穿透环境
> 首先需要登录微信公众平台，如果没有测试账号则需要申请，然后需要搭建内网穿透环境或者通过代理进行本地测试


  <div style="text-indent: 2em">vue 项目一般默认 localhost:8080，而微信的JS接口安全域名必须以 `http://、https://` 开头，由于公众号开发涉及到微信的回调，所以本地搭建的服务器需要外网能够访问，即需要把运行在内网的服务器映射到外网去给微信访问和手机端测试。这种外网和内网计算机连接通信的解决方案有两种：</div>
  <div style="text-indent: 2em">一是购买域名、云服务器并配置代理，二是使用内网穿透技术，将部署在本地的内网计算机服务直接穿透到外网，让外网通过一个指定的 IP 或域名来访问本地项目。我们一般通过 natapp 实现内网穿透，它的优点是拥有免费的通道，缺点是免费通道不稳定，每过一段时间外网地址会变更，还要更改项目的访问地址，具体的配置步骤如下：</div>


  1. 首先注册账号：点击注册 https://natapp.cn/register
  2. 登录后购买隧道：点击购买/免费，配置本地地址 http://127.0.0.1:80
  3. 本机运行 web 服务：配置地址 http://127.0.0.1:80
  4. 本机运行 natapp 服务
    * 首次需要下载 natapp.exe https://natapp.cn/#download
    * 我的隧道处获取 authtoken
    * 启动方式
      * 直接启动：natapp -authtoken=9ab6b9040a624f40
      * config.ini：[下载 config.ini 文件](https://natapp.cn/article/config_ini) 到 natapp.exe 同级目录，然后将 authtoken 填入保存，双击启动即可
  5. 测试 natapp 分配的网址：浏览器地址栏打开，注意需要拔掉电脑网线


## 测试账号配置
> 微信授权域名只支持 80 端口，务必使服务器监听80端口。注意测试号不支持微信支付

  1. __js 接口安全域名__
    * 配置：http://vbys39.natappfree.cc
    * 功能：用于实现应用中的微信分享等功能
  2. __接口配置信息__
    * URL：http://vbys39.natappfree.cc
    * Token：weixin，暂时可任意填写
  3. __授权回调页面域名__
    * 步骤：网页服务、网页账号、网页授权获取用户基本信息
    * 功能：用于应用中的微信用户登录、微信用户基本信息获取
    * 地址不需要 http、www 开头，只需要填写域名即可
    * 配置：vbys39.natappfree.cc
 

# 三、项目开发

## 接口调试
> 开发者工具、在线接口调试工具  

  1. 获取 access_token：输入 appid、secret
  2. 创建自定义菜单
    * 接口类型处选择自定义菜单选项
    * 输入内容创建，注意 access_token 失效和 body 数据格式
  3. 测试微信网页
    * 公众平台测试账号、测试号二维码、手机扫描查看新菜单


## 微信授权
>  步骤一是由前台完成的，前台获取 code 之后需要传给后台，由后台完成 2、3、4

  1. 前台通过 `location.href` 引导到授权页面，用户同意授权后跳转到带参数 code 的回调地址
  2. 后台通过 code 换取网页授权 `access_token`
  3. 开发者可以根据需要刷新网页授权 access_token，避免过期
  4. 后台通过网页授权 `access_token、openid` 获取用户基本信息（支持 UnionID 机制）




# 四、微信支付
  * 开发文档：https://pay.weixin.qq.com/wiki/doc/api/index.html
  * 解决方案：https://www.cnblogs.com/kenshinobiy/p/8878045.html


## 支付方式
  * __付款码支付__：用户打开 微信钱包、付款码，商户扫码后提交完成支付
  * __JSAPI 支付__：用户通过微信扫码、关注公众号等方式进入商家H5页面，并在微信内调用 JSSDK 完成支付
  * __Native 支付__：用户打开 "微信扫一扫"，扫描商户的二维码后完成支付
  * __APP 支付__：商户 APP 中集成微信 SDK，用户点击后跳转到微信内完成支付
  * __H5 支付__：用户在微信以外的手机浏览器请求微信支付的场景唤起微信支付
  * __小程序支付__：用户在微信小程序中使用微信支付的场景
  * __人脸支付__：无需掏出手机, 刷脸完成支付, 适合线下各种场景


### JSAPI 支付
> 主要用于商家在微信服务号中自建网页商城网站，用户通过链接或者二维码进入微信内部网页浏览器时，进行购买下单等支付操作时调用的流程。

  1. __开发准备__
    * 设置支付目录
    * 设置授权域名
  2. __开发流程__
    1. 用户通过链接或二维码进入网页
    2. 调用微信网页授权接口 [官方接口]
    3. 用户授权后获取用户信息 [官方接口]
    4. 封装商品信息并下单
    5. 调用微信统一下单接口 [官方接口]
    6. 根据统一下单接口返回信息组装前端需要的支付参数 [官方验证]
    7. 前端使用支付参数唤起微信支付界面[官方接口]
    8. 支付成功后微信异步调用统一下单时传入的回调接口 [官方接口]
    9. 更新商户订单信息


### APP 支付
> 适用于商户在移动端 APP 中集成微信支付功能。商户 APP 通过微信提供的 SDK 调用微信支付模块而跳转到微信中完成支付，支付完后跳回到商户 APP，最后展示支付结果。

  1. __开发流程__
    1. 用户进入商户 APP，选择商品下单、确认购买，进入支付环节。商户服务后台生成支付订单，签名后将数据传输到 APP 端
    2. 用户点击后发起支付操作，进入到微信界面，调起微信支付，出现确认支付界面
    3. 用户确认收款方和金额，点击立即支付后出现输入密码界面选择零钱或银行卡支付
    4. 输入正确密码后，支付完成，用户端微信出现支付详情页面
    5. 回跳到商户 APP 中，商户 APP 根据支付结果个性化展示订单处理结果
  2. __区别公众号支付__
    * 公众号支付需要进行用户授权获取用户信息，统一下单接口需要用户的 openid
    * APP 支付不需要用户授权，也不需要用户的 openid
    * APP 支付依赖于平台，如 iOS、Android，需要前端小伙伴配合 SDK开发，公众号直接调取 http/https 接口即可
    * 统一下单时类型不同，开发时注意个别字段的值变化


### H5 支付
> 需要在微信支付商户平台单独申请开通，否则无法使用

  1. 用户在商户侧（非微信客户端）完成下单请求支付订单
  2. 商户后台调用微信支付统一下单接口获取支付跳转 mweb_url
  3. 手机浏览器中访问 mweb_url 唤起微信进行支付
  4. 微信支付页面进行 H5 权限的校验，安全性检查
  5. 如果支付成功，商户后台会接收到微信侧的异步通知
  6. 用户在完成或取消支付后返回商户页面（默认返回支付发起页面）
  7. 商户后台处理支付结果并将结果返回给前端展示


### 小程序支付
> 小程序访问商户服务都是通过 HTTPS，开发部署的时候需要安装 HTTPS 服务器。商户系统和微信支付系统主要交互流程如下：

  1. 小程序内调用登录接口，获取用户 openid（小程序登录 API）
  2. 商户 server 调用支付统一下单（统一下单 API）
  3. 商户 server 调用再次签名（再次签名）
  4. 商户 server 接收支付通知（支付结果通知 API）
  5. 商户 server 查询支付结果（查询订单 API）


## 支付工具

  1. 代金券或立减优惠：商户营销和运营的能力，给用户发放代金券或立减优惠的相关说明
  2. 现金红包：提供给商户营销的能力，商户给用户派发现金红包相关说明
  3. 企业付款：企业付款至用户微信支付零钱或银行卡


## 注意事项
  <div style="text-indent: 2em">无论哪种支付方式，最终都会去调取 统一下单接口，这个接口主要是将商户中的订单信息拼接为支付信息传入到微信平台，微信平台会返回一个 预支付单 信息，我们对这个信息进行再次加密后拼接为实际支付所需的参数（五个字段参与签名、区分大小写）：`appId、nonceStr、package、signType、timeStamp`，然后给到微信提供的官方接口中即可调起支付页面了。</div>
  


























