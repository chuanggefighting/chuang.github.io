---
title: 微信公众号开发
tags:
  - 微信
categories: 移动端
top: false
keywords:
  - 微信
date: 2019-07-05 23:10:50
description: 
---

# 一、基础介绍

## 公众号类型
> 订阅号存放在一个文件夹中且需要点开查看关注，服务号直接显示在聊天列表。个人只能申请订阅号，几乎没有可用的接口。

  * __订阅号__：主要用于推送资讯而让用户阅读，每天只能群发一条消息。
  * __服务号__：主要用于为企业、政府等提供对用户的服务，比如银行的服务号可以让用户查询账单等，每个月只可群发四条消息。
  * __企业号__：主要用于公司内部通讯使用，旨在为用户提供移动办公，需要先有成员的通讯信息验证才可以关注成功企业微信。
  * __测试号__：用于开发测试及功能体验，是专门为开发人员准备的一种仅用于测试的公众号，但不可使用微信支付等高级功能。


## 微信公众平台
  <div style="text-indent: 2em">用于管理注册过的公众号，比如自定义菜单、自动回复、推送文章等，主要有两种管理模式：__编辑模式__就是为所有人提供的，如果你的需求仅仅只是最常见的菜单、自动回复等，使用编辑模式已经满足。但是如果你需求的功能比较复杂，就需要使用到__开发模式__。</div>

  * __编辑模式__
    * 主要针对非编程人员及信息发布类公众帐号使用。
    * 优点是可视化界面配置，操作简单，快捷，但是功能有限。
    * 开启后可以方便地通过界面配置 自定义菜单、自动回复的消息。
  * __开发模式__
    * 主要针对具备开发能力的人使用。
    * 通过编程可以实现更多复杂的功能，提供个性化服务。
    * 开启后能够使用微信公众平台的开放接口，但编辑模式的自定义菜单等功能会失效。


## 开发工具

  * 技术文档：[微信公众平台开发文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432/)、[接口在线调试网址](http://mp.weixin.qq.com/debug/)。
  * 测试账号：拥有几乎所有的公众号接口但不支持微信支付，主要用于手机端开发测试。
  * 微信开发者工具：自带"审查元素"功能的微信浏览器，用于调试微信端页面。使用前需要绑定开发者微信号 (公众平台首页、开发者工具)。
  * 微信接口在线调试：用于调试后端人员请求微信服务器的 API (获取 access_token、创建自定义菜单等)，执行后可通过手机扫描测试号二维码查看效果。


# 二、开发准备

## 公众号配置
> 手机端调试：扫码关注测试二维码。公众号的域名可以是 http/https 但小程序必须为 https。

  1. 注册一个服务号并认证通过：只有服务号可以开通微信支付。
  2. 管理员为开发者添加服务号和商户平台的用户管理权限：微信公众平台的权限为运营者微信号、微信商户平台的权限为员工账号。
  3. __开通微信支付功能__
    * 公众号：拥有通过微信认证的公众帐号且为服务号、服务号和商户平台必须是一个账户主体(认证的公司一致)。
    * 商户平台：产品中心处开通公众号支付、扫码支付等所需要的支付方式，然后配置支付授权目录。注意小程序也属于公众号支付，不需要单独开通。
  4. __配置公众号__
    * 测试账号：JS 接口安全域名 (用于实现微信分享等功能)、授权回调页面域名 (用于用户登录和基本信息获取，只支持 80 端口，务必使服务器监听 80 端口)、接口配置信息 (URL、Token 由后端提供)。
    * IP 白名单：只有白名单内的 IP 地址才可以拿着 id、secret 获取 assess_token。
    * 自定义菜单：上线时配置 公众号网址 + 前端提供各个菜单对应的路由，比如公司简介 `https://wx.shanghailife.com.cn/aboutus`。


## 搭建内网穿透环境
> 本地测试需要通过内网穿透环境或代理。

  <div style="text-indent: 2em">公众号开发涉及到微信的回调，所以本地调试的服务器需要外网能够访问。运行在本地的内网服务器和外网服务器实现连接通信的解决方案有两种：一是__购买域名、云服务器并配置代理__，将本地服务器网址映射到外网。二是使用__内网穿透技术__，让本地服务器直接穿透到外网。我们一般通过拥有免费通道的 natapp 实现内网穿透，但缺点是外网访问本地项目的地址经常会变化而不太稳定，具体的配置步骤如下：</div>


  1. 登录并购买免费隧道：首次需要[注册](https://natapp.cn/register)、点击购买并配置地址 `http://127.0.0.1:80`。
  2. 本机运行 web 服务：配置地址 `http://127.0.0.1:80`。
  3. 本机运行 natapp 服务：下载 [natapp.exe](https://natapp.cn/#download)、获取 authtoken (我的隧道处)。
    * 直接启动：__natapp -authtoken=9ab6b9040a624f40__
    * 通过 config.ini：[下载 config.ini](https://natapp.cn/article/config_ini) 并填入 authtoken 后双击启动。
  4. 测试 natapp 分配的网址：拔掉电脑网线后在浏览器地址栏打开即可。


## 微信接口参数
  
  * __appid__：公众号唯一标识。
  * __secret__：公众号开发密钥。
  * __openid__：用户单平台的唯一标识，每个微信用户关注后都会生成唯一的 openid。
  * __code__：用户授权时用于获取 access_token，只能使用一次且 5分钟未被使用则自动过期。
  * __unionid__：用户跨微信平台的唯一标识，同一个用户在公众号和小程序拥有相同的 unionid 和不同的 openid。
  * __response_type__ ：返回类型，固定为 code。
  * __redirect_uri__：完成授权后重定向的回调链接（注意转义）。
  * __state__：重定向后被微信原样返回，可用于前后对比来防止别人的攻击。
  * __scope__：授权方式。snsapi_base (不弹出授权页面而直接跳转，只能获取用户 openid)、snsapi_userinfo (弹出授权页面，可通过 openid 获取昵称、性别、所在地等信息)。
  * __#wechat_redirect__：直接在微信打开链接的可选参数。实现页面 302 重定向时必须携带。
  


# 三、项目开发

## 微信授权
> 用户通过扫码、点击按钮等方式跳转到授权页面，用户同意授权后则自动跳转到携带参数 code、state 的回调页面。

  <div align="center"> 
    ![微信公众号授权](/images/webchat/auth.png)
  </div>

  ```js
  // router.js
  import axios from 'axios'
  router.beforeEach(async (to, from, next) => {
    if (to.meta.noAuth) {      // 不需要用户授权
      next()
    } else {
      // 用户信息已存在则直接进入页面
      let userInfo = localStorage.getItem("userInfo")
      if (userInfo) {
        next()
        return
      }

      // 用户信息不存在则请求获取
      const code = getQuery("code")
      if(!code) {
        toAuth()
      }
      let res = await axios.get(requestLink('/WeChat?code=' + code))
      if (res.code === 200) {
        localStorage.setItem("userInfo", JSON.stringify(res.data))
        next()
      } else {
        toAuth()
      }
    }
  })

  // utils.js
  export default {
    isWechat: navigator.userAgent.toLowerCase().indexOf("micromessenger") > -1,
    isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
    getQuery(key){
      var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
      let r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]);
      return null;
    },
    toAuth(){
      const appid = window.appid
      let redirectUrl = encodeURIComponent(window.location.href)

      // 进入授权页面
      window.location.replace(`https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirectUrl}&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect`)
    }
  }

  // main.js
  let appid = {
        test: 'wx0431d286df253cea',
        uat: 'wx58656f9344fbc048',
        prd: 'wx7899e3317bf82ab8'
  };
  let domain, port = '';

  switch(process.env.NODE_ENV){//环境配置
    case "development":
          window.appid = appid.test
          domain = "10.52.200.2:9011"
          port = ""
      break
    case "production":
      if(location.href.indexOf('test') > -1){//test环境
        window.appid = appid.test
        domain = "shlife-test.zhongan.io"
      }else if(location.href.indexOf('wxdat') > -1){
        window.appid = appid.test
        domain = "wxdat.shanghailife.com.cn"
      }else if(location.href.indexOf('wxpre') > -1){//uat环境
        window.appid = appid.uat
        domain = "wxpre.shanghailife.com.cn"
      }else{  // 生产或者其它环境
        window.appid = appid.prd
        domain = "wx.shanghailife.com.cn"
      }
      break
  }
  window.requestLink = function(interfaceName){
    return location.protocol + "//" + domain + port + "/rest" + interfaceName
  }
  ```



# 四、微信支付
  * 开发文档：https://pay.weixin.qq.com/wiki/doc/api/index.html
  * 解决方案：https://www.cnblogs.com/kenshinobiy/p/8878045.html


## 支付方式
> 开发前配置：支付目录、授权域名。

  * __付款码支付__：用户打开 微信钱包、付款码，商户扫码后提交完成支付。
  * __JSAPI 支付__：用户通过微信扫码、关注公众号等方式进入商家 H5 页面，并在微信内调用 JSSDK 完成支付。
  * __Native 支付__：用户打开 "微信扫一扫"，扫描商户的二维码后完成支付。
  * __APP 支付__：商户 APP 中集成微信 SDK，用户点击后跳转到微信内完成支付。
  * __H5 支付__：用户在微信以外的手机浏览器请求微信支付的场景唤起微信支付。
  * __人脸支付__：无需掏出手机，刷脸完成支付，适合线下各种场景。
  * __小程序支付__：用户在微信小程序中使用微信支付。


### JSAPI 支付
> 主要用于商家在微信服务号中自建网页商城网站，用户通过链接或者二维码进入微信内部网页浏览器时，进行购买下单等支付操作时调用的流程。

  1. 用户通过链接或二维码进入网页
  2. 调用微信网页授权接口 [官方接口]
  3. 用户授权后获取用户信息 [官方接口]
  4. 封装商品信息并下单
  5. 调用微信统一下单接口 [官方接口]
  6. 根据统一下单接口返回信息组装前端需要的支付参数 [官方验证]
  7. 前端使用支付参数唤起微信支付界面[官方接口]
  8. 支付成功后微信异步调用统一下单时传入的回调接口 [官方接口]
  9. 更新商户订单信息


### APP 支付
> 适用于商户在移动端 APP 中集成微信支付功能。商户 APP 通过微信提供的 SDK 调用微信支付模块而跳转到微信中完成支付，支付完后跳回到商户 APP，最后展示支付结果。

  1. __开发流程__
    1. 用户进入商户 APP，选择商品下单、确认购买，进入支付环节。商户服务后台生成支付订单，签名后将数据传输到 APP 端
    2. 用户点击后发起支付操作，进入到微信界面，调起微信支付，出现确认支付界面
    3. 用户确认收款方和金额，点击立即支付后出现输入密码界面选择零钱或银行卡支付
    4. 输入正确密码后，支付完成，用户端微信出现支付详情页面
    5. 回跳到商户 APP 中，商户 APP 根据支付结果个性化展示订单处理结果
  2. __区别公众号支付__
    * 公众号支付需要进行用户授权获取用户信息，统一下单接口需要用户的 openid
    * APP 支付不需要用户授权，也不需要用户的 openid
    * APP 支付依赖于平台，如 iOS、Android，需要前端小伙伴配合 SDK开发，公众号直接调取 http/https 接口即可
    * 统一下单时类型不同，开发时注意个别字段的值变化


### H5 支付
> 需要在微信支付商户平台单独申请开通，否则无法使用

  1. 用户在商户侧（非微信客户端）完成下单请求支付订单
  2. 商户后台调用微信支付统一下单接口获取支付跳转 mweb_url
  3. 手机浏览器中访问 mweb_url 唤起微信进行支付
  4. 微信支付页面进行 H5 权限的校验，安全性检查
  5. 如果支付成功，商户后台会接收到微信侧的异步通知
  6. 用户在完成或取消支付后返回商户页面（默认返回支付发起页面）
  7. 商户后台处理支付结果并将结果返回给前端展示


### 小程序支付
> 小程序访问商户服务都是通过 HTTPS，开发部署的时候需要安装 HTTPS 服务器。商户系统和微信支付系统主要交互流程如下：

  1. 小程序内调用登录接口，获取用户 openid（小程序登录 API）
  2. 商户 server 调用支付统一下单（统一下单 API）
  3. 商户 server 调用再次签名（再次签名）
  4. 商户 server 接收支付通知（支付结果通知 API）
  5. 商户 server 查询支付结果（查询订单 API）


## 支付工具

  1. 代金券或立减优惠：商户营销和运营的能力，给用户发放代金券或立减优惠的相关说明
  2. 现金红包：提供给商户营销的能力，商户给用户派发现金红包相关说明
  3. 企业付款：企业付款至用户微信支付零钱或银行卡


## 注意事项
  <div style="text-indent: 2em">无论哪种支付方式，最终都会去调取统一下单接口，这个接口主要是将商户中的订单信息拼接为支付信息传入到微信平台，微信平台会返回一个 预支付单 信息，我们对这个信息进行再次加密后拼接为实际支付所需的参数（五个字段参与签名、区分大小写）：`appId、nonceStr、package、signType、timeStamp`，然后给到微信提供的官方接口中即可调起支付页面了。</div>
  


























